from __future__ import print_function
import json
import hashlib
from virus_total_apis import PublicApi as VirusTotalPublicApi
import time
from tqdm import tqdm

def create_json(EICAR_MD5, API_KEY):
	vt = VirusTotalPublicApi(API_KEY)
	response = vt.get_file_report(EICAR_MD5)
	j = json.dumps(response, sort_keys=False, indent=4)
	index = []
	try:
		for elem in response['results']['scans']:
			index.append(elem)
	
		sha1 = response['results']['sha1']
		sha256 = response['results']['sha256']
		md5 = response['results']['md5']
		scan_date = response['results']['scan_date']

		extern = []
		for i in range(0, len(index)):
			result = response['results']['scans'][index[i]]['result']
			if result is not None:	
				intern = []
				av = index[i]
				intern.append(av)
				intern.append(result)
				extern.append(intern)

		string = '{"sha1":"' + sha1 + '", '+'"av_labels":' + str(extern) + ', "scan_date":"' + scan_date + '", "sha256":"' + sha256 + '", "md5":"' + md5 + '"}'
		print(string.replace("'", '"'))
		return string.replace("'", '"')
	except KeyError:
		pass


def connection():
	API_KEY = '7883f503256ffab63e52ac70d6ec1fb12c039c47b5b4e72323e2974237508da0'
	old = open('LABELED_DATASET.txt', 'r')
	old_lines = old.readlines()
	lista = []
	for line in old_lines:
		ol = line.split('VirusShare_', 1)[1].split(' ')[0]
		print('Already DONE : ' + ol)
		lista.append(ol)
	print(lista)
	hashes = open('/home/winstonsmith/hash.txt', 'r')
	lines = hashes.readlines()
	count = 0
	for line in lines:
		print('COUNT: ' + str(count))
		if count < 400000000000000000000000000000:
			EICAR_MD5 = line
			if line not in lista:
				string = create_json(EICAR_MD5, API_KEY)
				file = open('/mnt/d/VIRUS_TOTAL_DESCRIPTION.txt', 'a')
				try:
					file.write(string)
					count = count + 1
				except:
					pass
		else:
			print('Now you need to wait ...')
#			time.sleep(2)
			count = 0	
			print('Processing ...')



connection()
