from androguard.misc import AnalyzeAPK
import pandas as pd
import numpy as np
import json
from PIL import Image
import os
from tqdm import tqdm
import signal
import sys


class TimeoutException(Exception):   # Custom exception class
    pass

def timeout_handler(signum, frame):   # Custom signal handler
    print('TIME ERROR')
    raise TimeoutException

# Change the behavior of SIGALRM
signal.signal(signal.SIGALRM, timeout_handler)

with open("/mnt/d/API_complete.json", "r") as fp:
        b = json.load(fp)

path = "/mnt/d/" + sys.argv[1] + '/'

for file in tqdm(os.listdir(path)):
        signal.alarm(2000)
        try:
                a, d, dx = AnalyzeAPK(path + file)
                G = dx.get_call_graph()
                df2 = pd.DataFrame(np.zeros((380, 380), dtype=int), index = b,
                                   columns=b)
                for edge in G.edges:
                        prima = str(edge[0]).split('->', 1)[1].split('(')[0]
                        seconda = str(edge[1]).split('->', 1)[1].split('(')[0]
                        terza = edge[2]
                        if prima not in b or seconda not in b:
                                break
                        df2.loc[prima, [seconda]] = terza

                x = df2.to_numpy()
                img = Image.fromarray((x * 255).astype(np.uint8))
                img.save('/mnt/d/' + sys.argv[1] +'_IMAGES/' + file + '.png')
        except:
                pass

        else:
                signal.alarm(0)
